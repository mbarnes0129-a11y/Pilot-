<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#f6f8ff">
  <title>DigiCoach 7-Stage — FIX (Battles + Store + Uploads)</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
  <script>
    // Cache buster — adds ?v with today's date to assets when SW is updated.
    window.__DIGI_VERSION__ = 'fix-' + new Date().toISOString().slice(0,10);
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try { await navigator.serviceWorker.register('service-worker.js?v='+window.__DIGI_VERSION__); } catch(e){ console.warn(e); }
      });
    }
  </script>
</head>
<body>
  <header>
    <div class="brand">🧭 DigiCoach 7-Stage</div>
    <div class="actions">
      <button id="btnSpeak" class="primary">🔊 Speak Status</button>
      <button id="btnMini">🧩 Mini HUD</button>
      <button id="btnStore">🏪 Store</button>
      <button id="btnSettings">⚙️ Settings</button>
      <button id="btnExport">⬇️ Export</button>
      <label class="import">⬆️ Import <input type="file" id="fileImport" accept="application/json" hidden></label>
      <button id="btnBypassCache" title="Force refresh assets">♻️ Bypass Cache</button>
    </div>
  </header>

  <main class="grid">
    <section class="card avatar">
      <h2 id="companionNameH">Companion</h2>
      <div class="pet-wrap">
        <img id="petImg" alt="Companion avatar" />
        <div class="hpbar big"><div id="buddyHPBar"></div></div>
        <div class="hptext small" id="buddyHPText">--/--</div>
      </div>
      <div class="evo-label">
        <span id="stageName">Egg</span>
        • <span class="typechip" id="typeChip">Flame</span>
      </div>
      <div class="stats">
        <div class="stat"><span>Level</span><strong id="level">1</strong></div>
        <div class="stat"><span>XP</span><div class="bar"><div id="xpBar"></div></div><strong id="xpNum">0 / 100</strong></div>
        <div class="stat"><span>Coins</span><strong id="coins">0</strong></div>
        <div class="stat"><span>Mood</span><strong id="mood">🙂</strong></div>
      </div>

      <div class="avatar-actions">
        <button data-pick="1">🥚 Egg</button>
        <button data-pick="2">🌱 In Training</button>
        <button data-pick="3">🐾 Rookie</button>
        <button data-pick="4">🛡️ Champion</button>
        <button data-pick="5">⚔️ Ultimate</button>
        <button data-pick="6">🔥 Mega</button>
        <button data-pick="7">👑 Grand Mega</button>
      </div>
      <!-- Hidden file inputs (one per stage) -->
      <input type="file" id="imgStage1" accept="image/*" hidden>
      <input type="file" id="imgStage2" accept="image/*" hidden>
      <input type="file" id="imgStage3" accept="image/*" hidden>
      <input type="file" id="imgStage4" accept="image/*" hidden>
      <input type="file" id="imgStage5" accept="image/*" hidden>
      <input type="file" id="imgStage6" accept="image/*" hidden>
      <input type="file" id="imgStage7" accept="image/*" hidden>

      <small class="ip-note">Tip: Tap a stage button to upload an image for that evolution (saved locally on device).</small>
    </section>

    <section class="card tasks">
      <h2>Daily Quests</h2>
      <ul id="taskList" class="task-list"></ul>
      <div class="task-new">
        <input id="taskInput" placeholder="New quest (e.g., 25 push-ups)">
        <input id="taskXP" type="number" min="1" max="200" value="10" title="XP">
        <input id="taskCoins" type="number" min="0" max="50" value="2" title="Coins">
        <button id="addTask">➕ Add</button>
      </div>
      <small id="dailyResetNote"></small>
    </section>

    <section class="card coach">
      <h2>Coach</h2>
      <div class="coach-text" id="coachText">This is the FIX build. If you just updated on GitHub Pages, press ♻️ Bypass Cache once.</div>
      <div class="coach-cta">
        <button id="btnCheer">💬 Cheer Me</button>
        <button id="btnPlan">🗓️ Plan My Day</button>
      </div>
    </section>

    <section class="card battle">
      <h2>Encounter</h2>
      <div class="battle-summary">
        <div>Campaign Day: <strong id="campDay">1</strong></div>
        <div>Battle <strong id="battleNo">1</strong> of <strong>3</strong></div>
        <div>Type: <strong id="battleType">Daily</strong></div>
        <div>Extra actions: <strong id="extraPool">0</strong></div>
        <div>Manual bonus: <input id="manualBonus" type="number" min="0" max="4" value="0" style="width:56px"></div>
        <div>Status: <strong id="battleStatus">Ready</strong></div>
      </div>
      <div class="battle-actions">
        <button id="btnStartBattle" class="primary">⚔️ Start Battle</button>
        <button id="btnResumeBattle" class="hidden">▶️ Resume</button>
      </div>
      <small>Three battles a day; boss day = two daily battles then a boss. Items can be used during battle and consume a turn. Extra actions cap at 4 and come from tasks done + manual bonus.</small>
    </section>
  </main>

  <aside id="miniHud" class="mini hidden">
    <div class="mini-top">
      <div class="mini-name"><span id="miniCompanion"></span> • Lv <span id="miniLevel"></span></div>
      <button id="miniSpeak">🔊</button>
      <button id="miniClose">✖</button>
    </div>
    <div class="mini-xp"><div id="miniXpBar"></div></div>
    <div class="mini-row">
      <span>🪙 <span id="miniCoins"></span></span>
      <span><span id="miniMood">🙂</span></span>
    </div>
  </aside>

  <!-- Settings -->
  <dialog id="settingsDialog">
    <form method="dialog" class="settings">
      <h3>Settings</h3>
      <label>Trainer Name<input id="trainerName"></label>
      <label>Companion Name<input id="companionName"></label>
      <label>Type
        <select id="typeSelect">
          <option>Flame</option>
          <option>Aqua</option>
          <option>Nature</option>
          <option>Storm</option>
          <option>Light</option>
          <option>Shadow</option>
        </select>
      </label>
      <label>Voice<select id="voiceSelect"><option value="">System Default</option></select></label>
      <div class="row">
        <button value="cancel">Cancel</button>
        <button id="saveSettings" value="ok" class="primary">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Store Modal -->
  <dialog id="storeDialog">
    <div class="store">
      <h3>🏪 Digi Store</h3>
      <div class="store-grid" id="storeItems"></div>
      <div class="row right"><button id="closeStore">Close</button></div>
    </div>
  </dialog>

  <!-- Battle Modal -->
  <dialog id="battleDialog">
    <div class="battle-ui light">
      <div class="battle-foes">
        <div class="you side">
          <div class="name"><span id="youName">You</span> — <span id="youStage"></span> • <span class="typechip" id="youType">Flame</span></div>
          <div class="hpbar"><div id="youHPBar"></div></div>
          <div class="hptext" id="youHPText"></div>
        </div>
        <div class="vs">VS</div>
        <div class="enemy side">
          <div class="name"><span id="enemyName">Enemy</span> — <span id="enemyStage"></span> • <span class="typechip" id="enemyType">Aqua</span></div>
          <div class="hpbar"><div id="enemyHPBar"></div></div>
          <div class="hptext" id="enemyHPText"></div>
        </div>
      </div>

      <div id="battleLog" class="battle-log"></div>

      <div class="battle-moves">
        <button id="moveA">Move 1</button>
        <button id="moveB">Move 2</button>
        <button id="moveC">Move 3</button>
        <button id="moveD">Move 4</button>
        <div class="ap">Extra actions left: <strong id="apLeft">0</strong></div>
      </div>

      <div class="battle-items">
        <select id="itemSelect"></select>
        <button id="useItem">🎒 Use Item</button>
      </div>

      <div class="battle-ctrl">
        <button id="btnBattleClose">Done</button>
      </div>
    </div>
  </dialog>

  <script src="app.js?v="></script>
</body>
</html>
